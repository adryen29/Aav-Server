<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Module de Jeu - Combat</title>
    <style>
        body { margin: 0; background: #1a1a1a; overflow: hidden; display: flex; justify-content: center; align-items: center; min-height: 100vh; font-family: sans-serif; }
        #game-wrapper { position: relative; width: 800px; height: 600px; border: 4px solid #444; box-shadow: 0 0 20px rgba(0,0,0,0.5); }
        canvas { background: #333; display: block; }
        
        /* Scores superposés pour gagner de la place */
        .score-panel { 
            position: absolute; top: 10px; width: 160px; 
            background: rgba(42, 42, 42, 0.8); border-radius: 6px; 
            padding: 10px; color: white; border: 1px solid rgba(255,255,255,0.1); 
            pointer-events: none; /* Ne gêne pas les clics sur le jeu */
        }
        #panel-left { left: 10px; }
        #panel-right { right: 10px; }
        
        h4 { margin: 0 0 5px 0; color: #3498db; text-transform: uppercase; font-size: 12px; border-bottom: 1px solid #444; }
        .score-item { display: flex; justify-content: space-between; margin-bottom: 2px; font-size: 12px; }
        
        #respawn-msg { 
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); 
            color: #e74c3c; font-size: 24px; font-weight: bold; display: none; 
            text-shadow: 2px 2px #000; text-align: center;
        }
    </style>
</head>
<body>
    <div id="game-wrapper">
        <div id="panel-left" class="score-panel">
            <h4>Top Records</h4>
            <div id="highscores-list"></div>
        </div>

        <canvas id="gameCanvas" width="800" height="600"></canvas>
        <div id="respawn-msg">DESTRUCTION...<br>RECONNEXION (3s)</div>

        <div id="panel-right" class="score-panel">
            <h4>Joueurs Actifs</h4>
            <div id="session-scores"></div>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const socket = io();
        const myName = localStorage.getItem('user') || "Anonyme";
        socket.emit('start game', myName);

        let players = {}; let bullets = []; let currentAngle = 0;
        const keys = {};

        socket.on('state', (s) => { 
            players = s; 
            updateScores();
            if(players[socket.id] && !players[socket.id].alive) {
                document.getElementById('respawn-msg').style.display = 'block';
            } else {
                document.getElementById('respawn-msg').style.display = 'none';
            }
        });

        socket.on('highscores', (hs) => {
            const list = document.getElementById('highscores-list');
            list.innerHTML = hs.map(h => `<div class="score-item"><span>${h.name}</span><b>${h.score}</b></div>`).join('');
        });

        socket.on('bullet', (b) => { bullets.push(b); });

        function updateScores() {
            const list = document.getElementById('session-scores');
            const sorted = Object.values(players).sort((a,b) => b.score - a.score);
            list.innerHTML = sorted.map(p => `<div class="score-item" style="color:${p.color}"><span>${p.name.substring(0,10)}</span><b>${p.score}</b></div>`).join('');
        }

        window.onkeydown = (e) => { 
            keys[e.key.toLowerCase()] = true;
            if(e.key === ' ' && players[socket.id]?.alive) { 
                e.preventDefault(); 
                const p = players[socket.id];
                socket.emit('shoot', { x: p.x+10, y: p.y+10, angle: currentAngle }); 
            }
        };
        window.onkeyup = (e) => { keys[e.key.toLowerCase()] = false; };

        function update() {
            if(!players[socket.id] || !players[socket.id].alive) return;
            let dx = 0, dy = 0;
            if (keys['z'] || keys['w']) dy -= 4;
            if (keys['s']) dy += 4;
            if (keys['q'] || keys['a']) dx -= 4;
            if (keys['d']) dx += 4;
            if (dx !== 0 || dy !== 0) {
                currentAngle = Math.atan2(dy, dx);
                socket.emit('move', { x: dx, y: dy, angle: currentAngle });
            }
            for (let i = bullets.length - 1; i >= 0; i--) {
                const b = bullets[i];
                b.x += Math.cos(b.angle) * 8;
                b.y += Math.sin(b.angle) * 8;
                for(let id in players) {
                    const p = players[id];
                    if(p.alive && b.owner !== id) {
                        const dist = Math.hypot(b.x - (p.x+10), b.y - (p.y+10));
                        if(dist < 15) {
                            if(b.owner === socket.id) socket.emit('hit', { victimId: id, shooterId: socket.id });
                            bullets.splice(i, 1);
                            break;
                        }
                    }
                }
                if (b.x < 0 || b.x > 800 || b.y < 0 || b.y > 600) bullets.splice(i, 1);
            }
        }

        function draw() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.strokeStyle = "#444"; ctx.lineWidth = 1;
            for(let i=0; i<800; i+=40) { ctx.beginPath(); ctx.moveTo(i,0); ctx.lineTo(i,600); ctx.stroke(); }
            for(let i=0; i<600; i+=40) { ctx.beginPath(); ctx.moveTo(0,i); ctx.lineTo(800,i); ctx.stroke(); }

            for (let id in players) {
                let p = players[id];
                if(!p.alive) continue;
                ctx.save();
                ctx.translate(p.x + 10, p.y + 10); ctx.rotate(p.angle);
                ctx.fillStyle = p.color; ctx.fillRect(-10, -10, 20, 20);
                ctx.fillStyle = "black"; ctx.fillRect(5, -2, 8, 4); 
                ctx.restore();
                
                ctx.fillStyle = "white";
                ctx.font = "bold 12px sans-serif";
                ctx.textAlign = "center";
                ctx.fillText(`[ ${p.score} ]`, p.x + 10, p.y - 18);
                ctx.font = "10px sans-serif";
                ctx.fillText(p.name, p.x + 10, p.y - 7);
            }
            
            ctx.fillStyle = "#ff0";
            bullets.forEach(b => { ctx.beginPath(); ctx.arc(b.x, b.y, 3, 0, Math.PI*2); ctx.fill(); });
            update();
            requestAnimationFrame(draw);
        }
        draw();
    </script>
</body>
</html>